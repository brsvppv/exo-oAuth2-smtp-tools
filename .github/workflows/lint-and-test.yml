name: Lint and Test
on: [pull_request]
jobs:
  precheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run pre-run helper (Check-PreRun)
        run: |
          pwsh -NoProfile -File .\Scripts\Check-PreRun.ps1
      - name: Upload gitleaks report (if generated)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-prerun-report
          path: gitleaks-prerun-report.json

  lint:
    needs: precheck
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PSScriptAnalyzer
        run: |
          pwsh -Command "Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser"
      - name: Run PSScriptAnalyzer and fail on disallowed rules
        run: |
          pwsh -NoProfile -Command "\
            $findings = Invoke-ScriptAnalyzer -Path . -Recurse -Severity Warning,Error;\
            $bad = $findings | Where-Object { $_.RuleName -in @('PSAvoidUsingWriteHost','PSUseApprovedVerbs','PSAvoidUsingConvertToSecureStringWithPlainText','PSAvoidUsingPlainTextForSecrets') };\
            if ($bad) { $bad | Select-Object FileName, Line, RuleName, Severity, Message | Format-Table -AutoSize; Write-Host 'Disallowed PSScriptAnalyzer rules detected.'; exit 1 }\
            else { Write-Host 'No disallowed PSScriptAnalyzer rules found.' }"
      - name: Run pre-run helper (Check-PreRun)
        run: |
          pwsh -NoProfile -File .\Scripts\Check-PreRun.ps1
  test:
    runs-on: windows-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Install PowerShell modules for tests
        run: |
          pwsh -c "Install-Module -Name Pester -Force -Scope CurrentUser"
      - name: Run Pester Tests
        run: |
          pwsh -Command 'Invoke-Pester -Output Detailed'
