name: Secret Scanning (scheduled & PR)
on:
  schedule:
    - cron: '0 0 * * 0' # weekly
  pull_request:
    types: [opened, synchronize]
jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: '--redact --report-format json --report-path gitleaks-report.json'
      - name: Upload gitleaks report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
      - name: Fail if gitleaks found secrets
        run: |
          python - <<'PY'
            import json,sys
            try:
                with open('gitleaks-report.json','r') as f:
                    data = json.load(f)
            except Exception as e:
                print('Could not read gitleaks report:', e)
                sys.exit(1)
            if isinstance(data, list) and len(data) > 0:
                print('gitleaks found {} secrets'.format(len(data)))
                sys.exit(1)
            print('No secrets found')
          PY
